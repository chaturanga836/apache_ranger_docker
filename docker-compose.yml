
services:
  # ------------------------------------------------
  # 1. PostgreSQL Database Service for Ranger
  # ------------------------------------------------

  ranger-zk:
    image: apache/ranger-zk:2.7.0
    container_name: ranger-zk
    restart: always

  ranger-solr:
    image: apache/ranger-solr:2.7.0
    container_name: ranger-solr
    restart: always
    depends_on:
      - ranger-zk

  ranger-db:
    image: apache/ranger-db:2.7.0 # Using the official Ranger DB image
    container_name: ranger-db
    restart: always
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rangeradmin -d ranger"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------------------------------------------------
  # 2. Apache Ranger Admin Service
  # ------------------------------------------------
  ranger-admin:
    image: apache/ranger:2.7.0
    container_name: ranger-admin
    restart: always
    user: root 
    environment:
      DB_HOST: ranger-db
      DB_USER: rangeradmin
      DB_PASSWORD: rangerR0cks! # Correct password from the script
      DB_NAME: ranger # Correct database name from the script
      SETUP_MODE: "1"
      DB_ROOT_USER: rangeradmin
      DB_FLAVOR: POSTGRES
      RANGER_HOST: ranger-admin
    ports:
      - "6080:6080"
    depends_on:
      ranger-db:
        condition: service_healthy
    command: /usr/local/bin/wait-for-it.sh ranger-db:5432 --timeout=60 -- /bin/bash -c "/opt/ranger/admin/setup.sh"
    healthcheck: # <--- Added health check for ranger-admin
        test: ["CMD-SHELL", "curl -f http://localhost:6080/ | grep 'Ranger Login' || exit 1"]
        interval: 10s
        timeout: 5s
        retries: 5

  # ------------------------------------------------
  # 3. Trino Service with Ranger Plugin
  # ------------------------------------------------
  trino:
    image: trinodb/trino:476
    container_name: trino
    depends_on:
      - plugin-downloader
    ports:
      - "8080:8080"
    volumes:
      - trino-plugin:/usr/lib/trino/plugin/ranger-trino-plugin
      - ./trino-ranger/config/etc:/etc/trino
      - ./trino-ranger/config/catalogs:/etc/trino/catalog
    command: ["/usr/lib/trino/bin/run-trino"]

  plugin-downloader:
    image: debian:bullseye-slim
    container_name: trino-plugin-downloader
    volumes:
      - trino-plugin:/usr/lib/trino/plugin/ranger-trino-plugin
    working_dir: /tmp
    entrypoint: ["sh", "-c"]
    command: >
      apt-get update &&
      apt-get install -y curl unzip ca-certificates &&
      mkdir -p /usr/lib/trino/plugin/ranger-trino-plugin/lib &&
      curl -sSL https://repo1.maven.org/maven2/io/trino/trino-ranger/476/trino-ranger-476.zip -o trino-ranger.zip &&
      unzip trino-ranger.zip -d /tmp/trino-ranger &&
      cp /tmp/trino-ranger/trino-ranger-476-services.jar /usr/lib/trino/plugin/ranger-trino-plugin/ &&
      cp /tmp/trino-ranger/*.jar /usr/lib/trino/plugin/ranger-trino-plugin/lib/ &&
      echo "Plugin installed successfully"

volumes:
  trino-plugin:
  ranger_db_data: